DROP PROGRAM JW5_ORDERS_MP_PRG:DBA GO
CREATE PROGRAM JW5_ORDERS_MP_PRG:DBA

PROMPT
	"OUTPUT TO FILE/PRINTER/MINE" = "MINE"
	, "PERSON ID:" = 15780379
	, "ENCOUNTER ID:" = 58947174.00
	, "CATALOGUE NAME:" = "RADIOLOGY"

WITH OUTDEV, PERSON_ID_VAR, ENCNTR_ID_VAR, CATALOG_NAME_VAR

; Create a record structure
FREE RECORD ORDERS_RS
RECORD ORDERS_RS (
	1 ORDERS_LST[*]
		2 ORDER_ID = F8
		2 ORDER_MN = VC
		2 ORDER_STATUS = VC
		2 ORDER_TIME = VC
		2 ORDER_DETAIL = VC
		2 ORDER_ACTIVE_DT = VC
		2 ORDERED_BY = VC
)

; Declare variables
DECLARE CANCELLED_CD_VAR = F8 WITH PUBLIC, NOCONSTANT(UAR_GET_CODE_BY("MEANING",6004,"CANCELED"))
DECLARE INCOMPLETE_CD_VAR = F8 WITH PUBLIC, NOCONSTANT(UAR_GET_CODE_BY("MEANING",6004,"COMPLETED"))
DECLARE DISCONTINUED_CD_VAR = F8 WITH PUBLIC, NOCONSTANT(UAR_GET_CODE_BY("MEANING",6004,"DISCONTINUED"))
DECLARE CATALOG_CD_VAR = F8 WITH PUBLIC, NOCONSTANT(UAR_GET_CODE_BY("DISPLAYKEY",6000, CNVTUPPER($CATALOG_NAME_VAR)))

; Get the data
SELECT INTO "NL:"
    ORDER_ID = O.ORDER_ID,
    ORDER_MNEMONIC = O.ORDER_MNEMONIC,
    ORDER_STATUS = UAR_GET_CODE_DISPLAY(O.ORDER_STATUS_CD),
    ORIG_ORDER_DT_TM = FORMAT(O.ORIG_ORDER_DT_TM, "MM/DD/YYYY HH:MM;;DQ"),
    ORDER_DETAIL_DISPLAY_LINE = O.ORDER_DETAIL_DISPLAY_LINE,
    ACTIVE_STATUS_DT_TM = FORMAT(O.ACTIVE_STATUS_DT_TM, "MM/DD/YYYY HH:MM;;DQ")
FROM
    ORDERS O
WHERE
    O.PERSON_ID = $PERSON_ID_VAR
    AND O.ENCNTR_ID = $ENCNTR_ID_VAR
    AND O.ORDER_STATUS_CD != CANCELLED_CD_VAR
    AND O.ORDER_STATUS_CD != INCOMPLETE_CD_VAR
    AND O.ORDER_STATUS_CD != DISCONTINUED_CD_VAR
    AND O.CATALOG_TYPE_CD = CATALOG_CD_VAR
ORDER BY
    O.ORIG_ORDER_DT_TM DESC
HEAD REPORT
	CNT = 0
HEAD O.ORDER_ID
	CNT = CNT + 1
	IF (SIZE(ORDERS_RS->ORDERS_LST,5)<CNT)
		STAT = ALTERLIST(ORDERS_RS->ORDERS_LST, CNT+10)
	ENDIF
	ORDERS_RS->ORDERS_LST[CNT].ORDER_ID = ORDER_ID
	ORDERS_RS->ORDERS_LST[CNT].ORDER_MN = TRIM(ORDER_MNEMONIC)
	ORDERS_RS->ORDERS_LST[CNT].ORDER_STATUS = TRIM(ORDER_STATUS)
	ORDERS_RS->ORDERS_LST[CNT].ORDER_TIME = TRIM(ORIG_ORDER_DT_TM)
	ORDERS_RS->ORDERS_LST[CNT].ORDER_DETAIL = TRIM(ORDER_DETAIL_DISPLAY_LINE)
	ORDERS_RS->ORDERS_LST[CNT].ORDER_ACTIVE_DT = TRIM(ACTIVE_STATUS_DT_TM)
FOOT REPORT
	STAT = ALTERLIST(ORDERS_RS->ORDERS_LST,CNT)
WITH NOCOUNTER, TIME = 1000

CALL ECHORECORD(ORDERS_RS)

;SET PUBLIC MEMORY VARIABLE EQUAL TO OUR JSON STRING
SET _MEMORY_REPLY_STRING = CNVTRECTOJSON(ORDERS_RS)

#EXIT_SCRIPT
FREE RECORD ORDERS_RS

END
GO
